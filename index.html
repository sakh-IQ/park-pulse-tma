<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü—É–ª—å—Å –ø–∞—Ä–∫–∞</title>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: white;
      padding: 20px;
    }
    .container { max-width: 400px; margin: auto; text-align: center; }
    .stat { margin: 10px 0; }
    .button { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 20px; color: white; cursor: pointer; }
    .button:hover { background: rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <div class="container">
    <h1>üå≥ –ü—É–ª—å—Å –ø–∞—Ä–∫–∞</h1>
    <div class="stat">üë£ –ó–∞ –¥–µ–Ω—å: <span id="dailyVisitors">--</span></div>
    <div class="stat">üö∂ –°–µ–π—á–∞—Å: <span id="currentVisitors">--</span></div>
    <div class="stat">‚òÄÔ∏è –ü–æ–≥–æ–¥–∞: <span id="weather">--</span></div>
    <button class="button" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="button" onclick="openParkingSnapshot()">üÖøÔ∏è –ü–∞—Ä–∫–æ–≤–∫–∞</button>
  </div>
  <input type="hidden" id="parkingUrl">

  <script>
    const SHEET_ID = '1z8_66-n2YOVqK62CspR6wZ3Qggbn2YihPsKjcZwWzf8';
    const WEATHER_API_KEY = '–¢–í–û–ô_API_–ö–õ–Æ–ß_–ü–û–ì–û–î–´';
    const WEATHER_CITY = 'Yuzhno-Sakhalinsk';

    async function fetchWeather() {
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_CITY}&appid=${WEATHER_API_KEY}&units=metric&lang=ru`;
        const res = await fetch(url);
        const data = await res.json();
        const temp = Math.round(data.main.temp);
        const desc = data.weather[0].description;
        return `${temp > 0 ? '+' : ''}${temp}¬∞ ${desc}`;
      } catch {
        return '–Ω/–¥';
      }
    }

    async function fetchDataFromGoogleSheets() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&range=B2:B4&headers=0`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const dailyVisitors = rows[0]?.c[0]?.v || '--';
        const currentVisitors = rows[1]?.c[0]?.v || '--';
        const parkingUrl = rows[2]?.c[0]?.v || '';

        return { dailyVisitors, currentVisitors, parkingUrl };
      } catch {
        return { dailyVisitors: '--', currentVisitors: '--', parkingUrl: '' };
      }
    }

    async function refreshData() {
      const [sheetData, weather] = await Promise.all([fetchDataFromGoogleSheets(), fetchWeather()]);

      document.getElementById('dailyVisitors').textContent = sheetData.dailyVisitors;
      document.getElementById('currentVisitors').textContent = sheetData.currentVisitors;
      document.getElementById('weather').textContent = weather;
      document.getElementById('parkingUrl').value = sheetData.parkingUrl;

      console.log('Parking URL:', sheetData.parkingUrl);
    }

    function openParkingSnapshot() {
      const url = document.getElementById('parkingUrl').value;
      if (url && url.startsWith('https://')) {
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.openLink(url);
        } else {
          window.open(url, '_blank');
        }
      } else {
        alert('–°–∫—Ä–∏–Ω—à–æ—Ç –ø–∞—Ä–∫–æ–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
    }

    refreshData();
    setInterval(refreshData, 120000);
  </script>
</body>
</html>
